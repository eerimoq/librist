stages:
  - build
  - analyze
  - test

.ubuntu-amd64-bionic:
    image: registry.videolan.org/dav1d-ubuntu-bionic:20200121182340
    stage: build
    tags:
        - docker
        - amd64

build-ubuntu:
    extends: .ubuntu-amd64-bionic
    tags:
        - docker
        - avx2
        - amd64
    script:
        - meson build --buildtype release --werror
        - ninja -C build

analyze-ubuntu:
    stage: analyze
    extends:
        - .ubuntu-amd64-bionic
    needs: ["build-ubuntu"]
    script:
        - curl -L https://github.com/danmar/cppcheck/archive/1.90.tar.gz > 1.90.tar.gz
        - tar xzf 1.90.tar.gz
        - cd cppcheck-1.90
        - make -j$(nproc)
        - cd ..
        - export PATH=$PATH:$(pwd)/cppcheck-1.90
        - meson build --buildtype release --werror -Dstatic_analyze=true
        - ninja -C build analyze

test-ubuntu:
    stage: test
    extends:
        - .ubuntu-amd64-bionic
    needs: ["build-ubuntu"]
    script:
        - curl -L https://cmocka.org/files/1.1/cmocka-1.1.5.tar.xz > cmocka-1.1.5.tar.xz
        - tar xf cmocka-1.1.5.tar.xz
        - mkdir -p cmocka-1.1.5/build && cd cmocka-1.1.5/build
        - cmake ..
        - make -j$(nproc)
        - cd ../..
        - export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$(pwd)/cmocka-1.1.5/build/src
        - meson build --buildtype release --werror -Dtest=true
        - ninja -C build
        - cd build && time meson test -v
